
# coding: utf-8

# In[1]:


import deap
#import NN
from walker_NN import NNN
from deap import base
from deap import creator
from deap import tools
import math
import gym
import random
from gym import wrappers
import time
import numpy as np
from deap import algorithms

nn = NNN()
env = gym.make("BipedalWalker-v2")
MAX_STEPS = 3700
w_list = []

def forward(network,X):
    def sigmoid(x):
        return 1 / (1 + np.exp(-x))
    W1, W2, W3 = network['W1'], network['W2'], network['W3']
    b1, b2, b3 = network['B1'], network['B2'], network['B3']
    a1 = np.dot(X,W1) + b1
    a1 = np.dot(X,W1) + b1
    z1 = a1
    a2 = np.dot(z1,W2) + b2
    z2 = a2
    a3 = np.dot(z2,W3) + b3
    y = (sigmoid(a3) - 0.5) * 2
    return y[0]

def conclusion(observation,individual,network):
    X = observation
    y = forward(network,X)
    action = y
    return action

def update(individual):
    network = {}
    network['W1'] = np.reshape(individual[:384],(24,16))
    network['B1'] = np.reshape(individual[384:400],(1,16))
    network['W2'] = np.reshape(individual[400:528],(16,8))
    network['B2'] = np.reshape(individual[528:536],(1,8))
    network['W3'] = np.reshape(individual[536:568],(8,4))
    network['B3'] = np.reshape(individual[568:572],(1,4))
    return network

def get_action(observation,individual,network):
    action = decide_action(observation,individual,network)
    return action

def decide_action(observation,individual,network):
    return conclusion(observation,individual,network)

if __name__=='__main__':
    observation = env.reset()
    episode_reward = 0
    individual = [0.7963643923525212, 0.04978691329212834, -0.5600601645153507, -0.03577020251783645, -0.22139828786829652, -0.6657951299014113, 0.7860253566310074, 0.2995876892844097, -1.8484454992938688, 1.0043709698476038, 0.19828372217629048, -1.9352227433693412, 3.8716134832534568, -1.792473877894193, 1.8929922368774983, -4.808383256284172, 0.7506152067001657, -0.5426657451132167, 0.2711090643612653, 0.45922934929238257, 1.4510128699682343, 0.4194812860269278, -0.8663925276396713, 2.0922329735245064, 0.6946399177771757, -0.8394600926882685, -0.4454040209398194, 1.6215618607690323, 0.3685445696372368, 1.5055432985426629, 0.8674888054895156, -1.2444950915988946, 2.162352932488257, -0.5117920200684887, -0.5005751951186019, 3.0286408985023705, -0.9003120426396349, 1.2360312510106872, 2.1907410013498057, 0.5274191147624958, -1.129505510081711, 0.6494833588925136, 0.5209266682844236, 0.19191825702892976, -0.3017974336927738, 0.26983347112213374, 0.6400813984568939, -0.5283083015761619, -0.06768123882122556, -0.8217987580178424, -1.6640330342063314, -0.17606206336197877, 0.13079010381632955, -0.15204304433899493, 1.0406428565616794, 1.4131141037867132, -0.014123844986038699, -5.815953898535934, 0.738796203231974, 0.4767074285416569, 0.3963234409689056, 1.7578007147815806, 2.2660176140447623, 0.198828127492938, -1.2448708176435161, 1.065489022192532, -0.9116186800647024, 1.6628680579452864, 1.1775165305371884, 0.357356612440519, -0.45570498423220784, 0.1743433874520457, -1.3266234379048418, 0.015925343821740517, 0.12293666410867328, 1.147467771470466, 4.258046570933137, 0.5178267773521552, -2.9865836492965885, -0.04695589550122568, 2.129523164066413, 1.005771680270871, -2.3956394083759625, -0.1686710712994502, 0.26458839846321597, -2.568684650663739, 1.8209233101779396, 0.3465741033121911, -1.0291643191739333, -1.4942223512403068, -0.6975594820837142, 0.01129595607856711, -1.714615927457789, -0.7547531021554287, 1.0470950642717236, -1.4708640189448299, 1.70045934200854, -1.7275259094292967, -3.0450424541685086, -0.06926252777381561, -1.2959731229473486, -0.9223873622721073, -2.398622874645783, -0.05133716320828177, 2.9360612128437964, -1.3064701277015005, 2.4243804306745735, 2.7295570395432485, 0.7708469532923843, -0.0937404007319779, 0.5625869925642659, -1.5131647217729298, -0.0071385020228455776, -0.39236782963767125, 0.275783502911241, 0.01902634672289005, 0.1727467005866454, -1.0487348845350497, 2.3415439250490717, 2.613018300988447, -0.2773283966942345, -0.18796154080459446, 1.1157040094560897, 1.264255714716891, 1.4391697503550234, 0.3234208444418554, -2.0462427736770796, -1.4443255799050552, 0.8275034895751538, -1.748463987488915, -0.4214298983433712, -1.0689809722696944, 0.3871049140821749, 1.8745862784334049, -0.5510824664676849, -0.002061445823811619, -0.21271285716861751, 0.29572434994238517, 1.2733896336587518, -1.3016863526582252, -0.6339789453669142, 2.5095627868583286, -1.26539323901815, -0.17855848359150805, 1.5434475999867203, -1.8103768581239266, -0.158366217660717, -1.1694744328863653, -2.2025590001784003, -0.13768577380781827, 0.20744753368351243, 0.8039932683444119, 0.35340386479874986, 0.17114991224102585, 1.9660988986287595, 2.9587243226285693, -0.9825051829173633, 0.7161212589742607, -1.0704339946257206, 0.7841681230557909, 2.0942759692951833, 2.364983819816328, -0.02336139447803256, 2.4957144768386166, -0.30355141528013085, -1.7233400283581175, -1.4145374964625748, 2.983144800642018, -1.4974940741325513, 0.5294598839727381, 0.9458089841309527, 1.678485617155189, -3.070846887438101, 0.3574790601843134, 1.8257882170442612, 0.4205361089225761, -2.2836706310766997, 2.5835427219662357, 1.1684666189740227, -1.0550556621296816, -1.6931586740221982, -0.20205921811302005, 0.5600099601189183, -0.5230429455884087, -0.512727989229246, -0.6093661700213652, -0.46199605094358237, -0.5186940700889193, -0.717778125256811, -0.28758881946772247, -0.3613639188104696, -0.3882822017814746, -1.1840919332201816, 2.4835829351361713, 1.1991061879248526, 0.20984995182918761, -0.9639995071868892, -2.0927753018374196, -2.163565822853294, -2.283814407551428, -0.57433352545512, 1.742861661991641, -0.017214853542085046, -1.8577913045113685, 0.2750525808696196, -0.11271842228664508, -2.0767442235102047, -0.8015296891956429, -0.742178792444492, 0.8161580634600358, 0.0880947231391282, -0.49690046373716934, 1.647906956574283, 0.6026827690048313, -1.1267727012997613, 0.32434738039324895, 1.2302001112938843, -0.4576077282844118, -1.177082177213693, 2.7793306943844223, 1.2456429912207, -3.0005591024409157, 1.7977135284550958, -0.11989445671971463, 0.580170845837942, -0.2349725608704668, 1.057849803763755, 0.5313120802085702, 1.3656545503018127, -0.05643797387536076, -0.31875701129446427, 1.1584003755695993, -0.6222485314762511, -1.6706001220138997, 0.07370349805115499, 0.7371709808071031, -1.7244539771559182, 1.111533693830582, 0.3141801531046823, -0.6194791547748915, 0.40189541920798144, -2.1156849268811215, -0.5833546800853893, -1.598933968997454, 0.7217963550154807, 1.0608302836467107, 2.299424331927077, -2.107543085827867, -0.08882552972917061, -0.08911292161104639, 0.6981780105995697, 0.5348181619008674, -1.6863424151014845, -0.36608018549191906, 0.06828426295527668, 0.4611698423260026, -0.7752784549816226, 3.747095711174015, -0.07593172258107612, 1.2525821287886818, 1.1240495688596819, -2.137837064188818, 0.148747985207918, -0.597699259938166, 1.1273116006849235, -0.126014050496208, -0.35836550986108595, 0.5702832478175707, -0.4041764608492826, -0.5083885517095788, 0.15090478460350568, 0.8958060443383057, -0.14082396339200476, 0.6819803619979942, 0.9559034690635345, -0.09251730767277094, 0.16979861624517856, 0.6121996313109157, -0.5894303997130694, -1.6190382618197068, 0.42172549834557027, 0.4011765295756633, 2.055581734646734, -0.6126771125201278, -0.9105110944985451, -1.2915849359486244, 0.2787670069896353, -1.0892034718635668, -2.3291585280593523, 0.14371781245954612, 0.21638702724793601, 0.9004837877275671, 1.4779278789656056, 1.1136011219824382, -1.4222041839364805, 2.357702733939245, 0.34883343287431773, -0.04673335899005946, -0.38231261117857773, -0.3053557230030363, -0.28738046242108006, 2.065217488470908, -1.49701105265817, 0.07498458483543168, -0.2965282318004081, 0.15411628599668725, 1.0864112773479748, -0.6772076458919702, -2.211959801751433, -0.007319324909427866, 2.1459325420628113, 0.6092000287973618, 0.5711498879021439, 0.003213770234845012, -1.1299633209606743, 1.9780692249814469, 2.774105521780738, -0.23478477904485956, -1.5618915173817483, 0.8381719967163996, -0.5632340999790102, -5.348670412618308, 1.0430769834895774, 0.9300588926373641, 3.438443285296021, -1.1448143308644154, 0.9673887842437603, 0.6721052077186848, 0.5895757141031424, 0.5835238077565558, -0.8217237757172495, -0.7857607216663516, 1.0332969064848445, -0.935028688433006, -0.26041646312494365, -1.0939260950610143, 0.5985274849348854, -0.2657829807566173, -2.8253242393204183, -0.85269381242162, -1.283809146929189, -0.13119363337927095, -1.0617557332715997, 1.3131191826158566, -1.812080352933572, 0.14349284248694005, 1.2886260872447302, 1.4053637164578938, -1.1853077253025428, -0.5628612222308986, 0.15831287874205563, -0.9284371774407569, -1.615055868375937, -2.306296734667071, -1.0293886098388945, -2.1096472714198637, -3.3966410775699396, -0.36931609678636584, 0.38003393713140987, -0.9143780374424809, 0.2252757112229193, -0.9484768877677793, -1.7197362027387295, -1.3329912122934582, -0.37715219194819066, -0.1958328816694397, -0.3092870939218957, 0.509106605617166, 0.33319652453008086, -1.406228695508088, 0.08404934012856058, -0.613336796298019, -0.5248769941432478, 0.20620474157772586, 1.130840067864255, 1.3894670825607343, 1.0258974431845191, 1.0620496998826514, -0.6793836714555823, -1.067223730700996, -0.7302790426531591, 0.775000282317135, -0.970711026282232, 1.525108229863033, 1.6571536203420092, 0.25511770240613624, 0.3000774729397108, -0.627270820536893, -0.03683664867617945, 2.146513767760967, -1.099876285884367, 0.8402395677929146, -0.9670400014879664, 0.45308176530267585, 0.9190048817195773, 0.8154068807421786, -0.5211930215674552, -0.45095875498079613, -0.42615416401030093, -0.7602185822206299, -1.1211890578691925, -1.0929655228382424, -0.014419985913102965, -1.2834549361163154, 0.4622644599214492, 0.013968585718156089, -1.2054236375966365, 0.7439333730523321, -0.7545282169853287, -0.03835871686140106, -1.0871201510508763, 1.3651459447323422, -2.55775316725766, 0.14494167191815124, 0.4306058531668075, 0.42972261457834016, -0.9247191471870597, -0.3534173499570066, -0.40472867847016714, -0.6680418498681602, 0.20330524306412526, -1.1234494086828815, -1.5543255925336945, -2.0435418153929477, -0.7188432036842424, -1.1686683523845183, 1.2642340008924022, 0.08170673977677656, 0.12611357313880706, 0.5923839038591934, -0.23496248683201038, -0.09359950123257889, -0.78476992442774, 0.6427787756039253, -0.09452502311874035, -0.2360934375069687, -0.6326881093924771, -0.17170041468138164, -1.0748066772674076, 0.24972225779029478, -0.02105606073241263, -0.039853522360151356, 0.9057152811607188, 0.6225413402771607, -0.12518362926901622, 1.0076808329452658, -0.10726737543301308, -0.6639774935922613, -0.03353887761294727, -0.5057319955763431, -0.802428934082607, -0.1158913729848011, -0.15967017629803618, -1.0642771888689837, -0.424813307009296, 0.5970897224721182, 2.1085424325112037, -0.07009964516174215, -0.06656972180552162, 0.5949883654441726, 1.4438732006145631, -0.26065474538188604, -0.7615675382281019, -0.9704705310114905, -0.3123863071834505, -1.30389790735597, 0.8719560227826519, -0.1761051273638174, 0.6094695874517694, -2.3859773773357693, -1.8053231670396541, -2.260599908564181, 1.2587206805642108, -1.0959414234350697, 0.14530212132832612, -0.5703671411059488, 0.49817704792049067, 0.8695631381479597, 0.021554847378373886, 0.658260889421002, 0.5967978781042945, 1.4413512287242258, -0.521161792537943, -1.9240462429884517, -1.9154035709788164, -0.39651852546075983, 0.19931585264795712, 1.1909667103279968, -1.156750199144805, -1.2321221278675578, 1.305218896347722, -1.7961864222892687, 0.05033866599565197, 0.46874120890777965, 0.5932932373822695, -1.1514826315765267, -2.6776336744264673, -1.8141683134847755, 0.14855870654932374, -0.30401130100758156, 2.542706297376883, 0.6158704820345099, 1.8080739899625828, 1.009925434355646, -1.5070277858312047, -0.11575779140132646, -0.7695758717040865, -0.31835067226748587, 2.686142756995239, -0.2404081585887482, 0.5063439394693422, 0.6593518221203907, 0.22395826912849492, 1.031196952943637, -0.03407677160207193, -1.2557881747228588, 1.439228301496773, -0.5778422695360108, -0.2780553766039547, -1.501550585702764, -2.0121514406874517, 1.034185469711238, -1.00267424522825, -0.3423953434197694, 0.19753731780753875, 0.5205675001365567, -2.2149075438026578, 0.6327248155111485, -0.7143178157301999, -0.09598979135224707, -0.9151460639552573, 0.010882080726129386, 0.28116773606632184, -0.893504118133669, -2.684676071807797, 0.5506020199893996, -1.8146198674932816, 0.9313213545386179, -0.13817795576147504, 0.05699653675507298, 1.5597190536815773, 0.08300185973285806, 0.8620815614928521, 0.2842869124282655, 0.9067578608548057, -0.9210737048845918, -0.03159946612028302, -1.2729244352178224, -1.3232403835182744, 2.121812954132608, -0.8564611954318373, -0.304270426295724, -1.2596337955777253, 1.737323209962558, 2.095202212326194, 0.2132125402905654, -2.4376556526231115, 1.0380600078105284, -0.6399396669449915, 0.9913808257354777, 0.9053041508109667, 0.9668956304402677, 1.9035181120047655, 0.16465448693169593, 1.795710961785881, 0.7533723770815606, 1.5256517232047262, 2.05786216715774, -0.1785347993962611, 0.4535005833337145, -0.28867866054031277, -1.712730500526395]
    network = update(individual); #networkにindividualを適用
    observatin = env.reset()
    episode_reward = 0
    while True:
        action = get_action(observation,individual,network)
        time.sleep(0.001)
        env.render()
        observation,reward,done,info = env.step(action)
        #observation,reward,done,info = env.step([-1,1,0,0])
        episode_reward += reward
        #print(action," : ",episode_reward)
        if done:
            env.render()
            break
    print(episode_reward)
