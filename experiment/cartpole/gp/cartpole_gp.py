import numpy as np
from deap import algorithms,base,creator,tools,gp
import random
import operator
import math
import gym
from gym import wrappers
import time
import  networkx as nx
import matplotlib.pyplot as plt

ENV = gym.make("CartPole-v2")
MAX_STEPS=5000
NGEN=300

def safeDiv(left,right):
    if(right==0):
        return 0
    try:
        return left/right
    except ZeroDivisionError:
        return 0

pset = gp.PrimitiveSet("MAIN", 4)
pset.addPrimitive(operator.add, 2)
pset.addPrimitive(operator.sub, 2)
pset.addPrimitive(operator.mul, 2)
pset.addPrimitive(safeDiv,  2)
pset.addPrimitive(operator.neg, 1)
pset.addPrimitive(math.cos, 1)
pset.addPrimitive(math.sin, 1)
pset.addEphemeralConstant("rand101", lambda:random.randint(-1,1))
"""
pset.renameArguments(ARG0='x')
pset.renameArguments(ARG1='v')
pset.renameArguments(ARG2='theta')
pset.renameArguments(ARG3='av')
"""
pset.renameArguments(ARG0='theta')
pset.renameArguments(ARG1='av')
pset.renameArguments(ARG2='x')
pset.renameArguments(ARG3='v')
'''
pset.addEphemeralConstant("theta2", lambda:ARG0*2)
pset.addEphemeralConstant("theta3", lambda:ARG0*3)
pset.addEphemeralConstant("theta4", lambda:ARG0*4)
'''
creator.create("FitnessMax",base.Fitness,weights=(1.0,))
creator.create("Individual",gp.PrimitiveTree,fitness=creator.FitnessMax)

toolbox = base.Toolbox()
toolbox.register("expr", gp.genHalfAndHalf, pset=pset, min_=1, max_=2)
toolbox.register("individual", tools.initIterate, creator.Individual, toolbox.expr)
toolbox.register("population",tools.initRepeat,list,toolbox.individual)
toolbox.register("compile", gp.compile, pset=pset)

def EV(individual):
        observation = ENV.reset()
        episode_reward=0
        for step in range(MAX_STEPS):
            action = get_action(observation,individual)

            observation_next,reward,done,info_not = ENV.step(action)
            episode_reward += reward
            if done:
                #ENV.render()
                break

            observation = observation_next
            
            #if Myclass.count>=2700:
            #    env = wrappers.Monitor(env,'./movie/cartpole-experiment-1')
            #ENV.render()
        return episode_reward,

toolbox.register("evaluate", EV)
toolbox.register("mate", gp.cxOnePoint)
#toolbox.register("mutate", tools.mutGaussian, mu=0, sigma=1, indpb = 0.1)
toolbox.register("select",tools.selTournament,tournsize=3)
toolbox.register("expr_mut", gp.genFull, min_= 0, max_ = 2)

toolbox.decorate("mate", gp.staticLimit(key=operator.attrgetter("height"), max_value=17))
toolbox.decorate("mutate", gp.staticLimit(key=operator.attrgetter("height"), max_value=17))

def get_action(observation,individual):
    action = decide_action(observation,individual) ##
    return action
    #observation[カートの位置，カートの速度，棒の角度，棒の角速度]
def decide_action(observation,individual):
    func = toolbox.compile(expr=individual)
    if(func(observation[2],observation[3],observation[0],observation[1]) >= 0):
        return 1
    else :
        return 0

def main():
        random.seed(1)
        pop = toolbox.population(n=250)
        hof = tools.HallOfFame(1)

        stats_fit= tools.Statistics(lambda ind: ind.fitness.values)
        stats_size = tools.Statistics(len)

        mstats = tools.MultiStatistics(fitness=stats_fit,size=stats_size)
        mstats.register("avg", np.mean)
        #mstats.register("std", np.std)
        #mstats.register("min", np.min)
        mstats.register("max", np.max)
        CXPB=0.5
        MUTPB=0.1
        pop,log = algorithms.eaSimple(pop, toolbox, CXPB, MUTPB, NGEN, stats = mstats, halloffame=hof,verbose=True)
        return pop, log, hof

if __name__=='__main__':
    pop,log,hof = main()
    print(hof)
    print()
    print()
    print()
    expr = tools.selBest(pop,1)[0]
    print(expr)
    nodes, edges, labels = gp.graph(expr)
    print(nodes)
    print(edges)
    print(labels)
    nodes, edges, labels = gp.graph(expr)
    print(nodes)
    print(edges)
    print(labels)
    g = nx.Graph()
    g.add_nodes_from(nodes)
    g.add_edges_from(edges)
    pos = nx.drawing.nx_agraph.graphviz_layout(g,prog="dot")
    print(pos)
    nx.draw_networkx_nodes(g,pos)
    nx.draw_networkx_edges(g, pos)
    nx.draw_networkx_labels(g,pos,labels)
    plt.show()
"""
              fitness           size   
            ------------    -----------
gen nevals  avg     max     avg     max
0   250     43.068  2753    3.544   7  
1   133     100.504 3160    3.684   9  
2   122     172.844 5000    4.036   9  
3   142     317.24  5000    4.008   9  
4   143     523.98  5000    4.072   9  
5   116     967.32  5000    4.148   9  
6   154     1365.33 5000    4.5     11 
7   136     1689.54 5000    4.444   12 
8   143     2245.45 5000    4.528   11 
9   130     2418.56 5000    4.408   11 
10  120     2708.47 5000    4.396   10 
11  141     2699.23 5000    4.444   10 
12  153     2283.92 5000    4.448   11 
13  140     2530.85 5000    4.444   11 
14  150     2487.66 5000    4.516   12 
15  132     2608.08 5000    4.504   13 
16  108     3034.75 5000    4.564   10 
17  127     2996.26 5000    4.48    12 
18  118     3112.19 5000    4.508   11 
19  136     2818.14 5000    4.6     12 
20  116     2987.26 5000    4.6     9  
21  149     2539.34 5000    4.788   10 
22  126     2739.54 5000    4.708   11 
23  145     2698.38 5000    4.68    10 
24  128     2820.36 5000    4.624   9  
25  146     2648.81 5000    4.712   9  
26  153     2350.4  5000    4.76    11 
27  146     2598.85 5000    4.52    10 
28  126     2758.69 5000    4.624   12 
29  137     2836.79 5000    4.604   12 
30  155     2480.02 5000    4.452   12 
31  138     2645.9  5000    4.552   13 
32  127     2721.03 5000    4.556   11 
33  144     2383.39 5000    4.64    10 
34  155     2494.38 5000    4.62    15 
35  135     2707.02 5000    4.788   12 
36  129     2662.78 5000    4.648   11 
37  132     2806.74 5000    4.8     11 
38  144     2528.36 5000    4.744   12 
39  128     2931.86 5000    4.78    10 
40  142     2774.74 5000    4.776   13 
41  129     2788.22 5000    4.672   10 
42  143     2735.45 5000    4.764   11 
43  147     2683.33 5000    4.528   12 
44  134     2892.29 5000    4.392   12 
45  156     2567.75 5000    4.316   12 
46  135     2936.04 5000    4.42    12 
47  149     2584.39 5000    4.176   12 
48  158     2697.83 5000    4.508   16 
49  147     2831.24 5000    4.568   14 
50  124     2953.61 5000    4.456   12 
51  144     2780.86 5000    4.524   12 
52  111     3250.22 5000    4.58    13 
53  143     2899.81 5000    4.728   14 
54  150     2851.85 5000    4.916   17 
55  148     2813.81 5000    5.416   18 
56  152     2837.1  5000    5.44    18 
57  159     2853.08 5000    5.584   20 
58  134     2873.83 5000    6.048   20 
59  149     2883.95 5000    6.136   18 
60  154     2835.04 5000    6.672   17 
61  135     3028.69 5000    7.236   18 
62  145     3026.45 5000    7.384   18 
63  145     2826.96 5000    7.944   17 
64  147     3012.28 5000    8.728   20 
65  150     3229.94 5000    8.716   20 
66  153     3015.08 5000    9.096   22 
67  125     3237.62 5000    9.588   27 
68  143     3160.12 5000    9.696   27 
69  131     3300.48 5000    10.428  27 
70  144     3447.75 5000    10.976  24 
71  140     3255.68 5000    11.376  26 
72  128     3779.82 5000    11.396  26 
73  143     3367.23 5000    11.096  26 
74  144     3454.18 5000    11.14   29 
75  158     3392.13 5000    11.652  31 
76  147     3276.27 5000    11.896  31 
77  158     2919.14 5000    12.988  32 
78  131     3182.03 5000    13.04   33 
79  139     3246.4  5000    13.108  31 
80  127     3594.8  5000    13.22   34 
81  142     3460.18 5000    13.096  32 
82  129     3355.95 5000    13.18   32 
83  128     3592.91 5000    13.712  33 
84  144     3446.26 5000    14.116  37 
85  139     3511.24 5000    14.172  30 
86  128     3759.58 5000    14.248  37 
87  128     3720.24 5000    15.344  38 
88  164     3534.35 5000    15.416  36 
89  139     3534.76 5000    16.536  42 
90  138     3675.78 5000    17.892  48 
91  112     3730.1  5000    18.48   58 
92  138     3740.17 5000    18.62   58 
93  160     3565.28 5000    18.508  44 
94  144     3595.97 5000    19.74   69 
95  143     3799.64 5000    21.888  72 
96  123     4007.26 5000    21.824  71 
97  146     3639.93 5000    22.164  71 
98  142     3882.58 5000    22.616  77 
99  144     4096    5000    23.952  95 
100 139     3811.18 5000    25.412  95 
101 136     4072.96 5000    27.312  95 
102 148     3912.77 5000    27.944  101
103 139     3936.7  5000    29.684  100
104 156     3996.82 5000    32.32   98 
105 139     4082.7  5000    35.3    113
106 134     4090.33 5000    36.508  99 
107 143     4076.12 5000    38.968  99 
108 128     4047.86 5000    41.396  104
109 130     4081.09 5000    43.732  112
110 150     4223.06 5000    45.572  106
111 134     4236.24 5000    47.22   106
112 141     4371.93 5000    46.508  106
113 129     4266.46 5000    46.86   120
114 138     4263.64 5000    46.96   123
115 124     4402.06 5000    49.496  144
116 147     4165.46 5000    50.76   130
117 144     4084.49 5000    52.64   134
118 125     4498.39 5000    56.436  134
119 134     4401.16 5000    58.816  147
120 143     4290.85 5000    60.464  147
121 143     4415.02 5000    59.048  147
122 128     4382.21 5000    63.356  147
123 124     4587.48 5000    64.904  147
124 132     4547.45 5000    63.536  123
125 157     4355.91 5000    66.772  138
126 127     4415.38 5000    65.436  138
127 132     4375.1  5000    63.296  138
128 134     4221.66 5000    62.828  138
129 146     4374.02 5000    65.724  140
130 120     4613.82 5000    65.54   138
131 148     4315.22 5000    65.584  132
132 145     4622.26 5000    71.38   131
133 126     4552.42 5000    70.052  203
134 147     4563.44 5000    73.696  141
135 165     4328.17 5000    70.376  164
136 130     4581.7  5000    73.096  164
137 150     4395.7  5000    73.472  143
138 138     4534.81 5000    71.104  141
139 139     4331.92 5000    71.592  159
140 137     4369.76 5000    71.632  181
141 127     4646.81 5000    73      191
142 131     4514.09 5000    72.548  191
143 132     4686.99 5000    72.668  191
144 134     4444.3  5000    73.288  190
145 128     4633.43 5000    74.536  182
146 131     4477.07 5000    75.168  181
147 136     4400.66 5000    71.2    181
148 133     4423.36 5000    75.548  185
149 128     4570.56 5000    76.496  181
150 121     4599.51 5000    75.216  184
151 140     4479.72 5000    75.488  184
152 135     4529.12 5000    73.864  187
153 131     4592.63 5000    74.28   160
154 133     4681.02 5000    79.408  165
155 147     4554.87 5000    80.72   165
156 159     4546.97 5000    82.856  165
157 116     4519.42 5000    81.508  169
158 139     4522.03 5000    81.616  165
159 140     4594.38 5000    80.108  164
160 148     4458.99 5000    78.312  164
161 146     4420.72 5000    79.736  165
162 146     4387.78 5000    80.38   169
163 152     4265.79 5000    79.1    163
164 134     4744.19 5000    78.888  168
165 107     4679.34 5000    82.016  168
166 144     4468.94 5000    79.244  168
167 126     4403.57 5000    81.552  162
168 133     4564.47 5000    81.056  162
169 123     4523.45 5000    80.728  169
170 126     4545.5  5000    79.396  169
171 123     4576.04 5000    80.816  170
172 115     4665.3  5000    78.296  174
173 163     4659.68 5000    80.132  174
174 136     4579.79 5000    82.332  194
175 140     4754.47 5000    85.808  194
176 133     4469.39 5000    83.644  194
177 128     4615.52 5000    90.264  194
178 123     4544.06 5000    87.156  174
179 151     4443.22 5000    95.172  174
180 152     4435.52 5000    95.128  203
181 146     4551.52 5000    97.704  203
182 146     4454.45 5000    99.816  203
183 149     4579.54 5000    101.152 204
184 130     4539.13 5000    100.732 204
185 133     4747.62 5000    105.664 206
186 138     4682.76 5000    103.956 211
187 152     4634    5000    102.3   211
188 112     4672.4  5000    102.484 211
189 125     4718.76 5000    104.972 210
190 112     4686.17 5000    102.924 210
191 143     4598.75 5000    102.872 211
192 149     4512.76 5000    94.604  210
193 131     4611.8  5000    97.464  210
194 164     4522.28 5000    98.616  210
195 138     4560.83 5000    97.308  216
196 136     4550.23 5000    98.616  200
197 143     4568.78 5000    100.1   200
198 128     4576.29 5000    96.4    174
199 143     4596.25 5000    95.94   181
200 151     4353.79 5000    93.78   184
201 149     4516.66 5000    98.884  184
202 143     4534.45 5000    99.108  184
203 132     4667.38 5000    98.84   176
204 146     4377.2  5000    95.228  192
205 144     4368.59 5000    94.536  177
206 124     4524.4  5000    91.924  175
207 133     4449.72 5000    90.364  191
208 138     4551.4  5000    96.296  191
209 122     4662.38 5000    100.624 187
210 142     4619.72 5000    103.82  187
211 136     4530.42 5000    105.892 186
212 131     4592.12 5000    108.036 184
213 143     4585.59 5000    106.968 192
214 143     4485.24 5000    104.6   184
215 126     4635.95 5000    102.452 184
216 154     4533.45 5000    104.504 203
217 128     4609.69 5000    104.032 203
218 126     4592.03 5000    103.104 184
219 154     4597.29 5000    105.152 188
220 134     4631.6  5000    104.144 188
221 146     4552.28 5000    107.956 188
222 142     4803.72 5000    109.556 192
223 131     4679.68 5000    112.004 192
224 127     4739.09 5000    111.256 197
225 146     4653.86 5000    110.276 196
226 134     4711.76 5000    106.264 209
227 143     4472.09 5000    106.004 209
228 122     4664.94 5000    105.488 211
229 147     4710.69 5000    107.012 211
230 142     4603.07 5000    103.272 211
231 141     4688.8  5000    104.376 210
232 141     4455.55 5000    105.812 218
233 137     4491.93 5000    107.244 210
234 143     4532.76 5000    106.636 212
235 128     4600.04 5000    105.768 215
236 124     4645.72 5000    109.632 210
237 134     4526.51 5000    112.472 216
238 126     4660.79 5000    118.332 231
239 140     4612.18 5000    118.72  231
240 147     4688.34 5000    121.968 231
241 146     4549.17 5000    121.616 242
242 117     4779.32 5000    125.108 243
243 124     4666.62 5000    121.644 242
244 153     4562.54 5000    125.512 257
245 156     4456.16 5000    124.384 247
246 135     4616.06 5000    121.364 247
247 133     4554.59 5000    125.568 249
248 136     4654.12 5000    124.54  246
249 141     4497.96 5000    125.772 244
250 123     4617.89 5000    127.848 250
251 162     4586.6  5000    123.792 256
252 138     4663.96 5000    125.444 256
253 138     4555.38 5000    126.488 271
254 117     4461.04 5000    130.328 247
255 123     4779.32 5000    135.944 252
256 128     4627.34 5000    137.12  252
257 155     4732.64 5000    141.344 252
258 128     4616.98 5000    141.464 252
259 142     4693.71 5000    137.84  226
260 153     4591.16 5000    142.788 243
261 127     4638.34 5000    143.656 229
262 142     4753.17 5000    142.544 230
263 157     4669.46 5000    134.54  227
264 139     4735.53 5000    136.124 248
265 137     4514.82 5000    135.904 232
266 121     4707.78 5000    138.456 245
267 153     4754.74 5000    142.22  251
268 125     4687.13 5000    139.02  272
269 139     4499.45 5000    141.552 273
270 128     4630.36 5000    147.952 233
271 135     4718.24 5000    152.492 233
272 117     4586.1  5000    153.924 236
273 135     4721.32 5000    154.168 251
274 144     4739.54 5000    148.664 251
275 151     4648.74 5000    145.56  261
276 128     4689.5  5000    147.768 256
277 131     4744.91 5000    144.096 221
278 154     4612.13 5000    143.368 227
279 126     4701.75 5000    140.792 220
280 146     4701.19 5000    138.352 222
281 172     4454.76 5000    139.52  222
282 146     4653.18 5000    136.912 222
283 135     4602.22 5000    140.512 242
284 126     4522.93 5000    141.424 242
285 119     4715.04 5000    144.136 238
286 121     4683.46 5000    144.672 236
287 132     4399.56 5000    147.04  227
288 155     4505.01 5000    148.028 236
289 150     4635.6  5000    144.524 236
290 136     4552.56 5000    139.612 233
291 123     4615.18 5000    139.932 223
292 135     4632.67 5000    136.56  222
293 142     4698.11 5000    134.532 223
294 145     4656.37 5000    128.088 223
295 131     4532.3  5000    122.52  249
296 152     4575.57 5000    124.76  238
297 142     4581.82 5000    123.9   224
298 131     4541.96 5000    126.332 216
299 130     4503.1  5000    122.076 218
300 126     4592.92 5000    123.44  216
""