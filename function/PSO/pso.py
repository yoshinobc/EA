import operator
import random

import numpy

from deap import base
from deap import benchmarks
from deap import creator
from deap import tools

creator.create("FitnessMin", base.Fitness, weights=(-1.0,))
creator.create("Particle", list, fitness=creator.FitnessMin, speed=list,
    smin=None, smax=None, best=None)

def generate(size, pmin, pmax, smin, smax):
    part = creator.Particle(random.uniform(pmin, pmax) for _ in range(size))
    part.speed = [random.uniform(smin, smax) for _ in range(size)]
    part.smin = smin
    part.smax = smax
    return part

def updateParticle(part, best, phi1, phi2):
    u1 = (random.uniform(0, phi1) for _ in range(len(part)))
    u2 = (random.uniform(0, phi2) for _ in range(len(part)))
    v_u1 = map(operator.mul, u1, map(operator.sub, part.best, part))
    v_u2 = map(operator.mul, u2, map(operator.sub, best, part))
    part.speed = list(map(operator.add, part.speed, map(operator.add, v_u1, v_u2)))
    for i, speed in enumerate(part.speed):
        if speed < part.smin:
            part.speed[i] = part.smin
        elif speed > part.smax:
            part.speed[i] = part.smax
    part[:] = list(map(operator.add, part, part.speed))

toolbox = base.Toolbox()
toolbox.register("particle", generate, size=2, pmin=-6, pmax=6, smin=-3, smax=3)
toolbox.register("population", tools.initRepeat, list, toolbox.particle)
toolbox.register("update", updateParticle, phi1=2.0, phi2=2.0)
toolbox.register("evaluate", benchmarks.himmelblau)

def main():
    pop = toolbox.population(n=100)
    stats = tools.Statistics(lambda ind: ind.fitness.values)
    stats.register("avg", numpy.mean)
    stats.register("std", numpy.std)
    stats.register("min", numpy.min)
    stats.register("max", numpy.max)

    logbook = tools.Logbook()
    logbook.header = ["gen", "evals"] + stats.fields

    GEN = 1000
    best = None

    for g in range(GEN):


        for part in pop:
            part.fitness.values = toolbox.evaluate(part)
            if not part.best or part.best.fitness < part.fitness:
                part.best = creator.Particle(part)
                part.best.fitness.values = part.fitness.values
            if not best or best.fitness < part.fitness:
                best = creator.Particle(part)
                best.fitness.values = part.fitness.values
        for part in pop:
            toolbox.update(part, best)

        # Gather all the fitnesses in one list and print the stats
        logbook.record(gen=g, evals=len(pop), **stats.compile(pop))
        print(logbook.stream)

    return pop, logbook, best

if __name__ == "__main__":
    main()

"""
gen     evals   avg     std     min     max
0       100     288.04  263.398 5.0069  1215.43
1       100     169.719 310.906 0.744422        1758.57
2       100     222.123 319.349 1.66903         1816.33
3       100     255.558 410.065 1.09348         2686.41
4       100     289.274 435.006 1.24546         2567.66
5       100     195.06  403.662 0.471099        3021.02
6       100     158.98  238.065 0.067838        1556.87
7       100     234.6   464.296 0.164083        3940.16
8       100     239.112 325.014 0.206086        1975.54
9       100     198.539 333.695 0.298178        2044.78
10      100     168.291 267.377 0.174547        1684.32
11      100     155.225 225.543 0.19401         1368.43
12      100     196.188 291.29  2.02058         1723.97
13      100     144.436 189.964 0.0932184       828.023
14      100     159.616 219.472 1.93519         1048.93
15      100     163.17  241.626 0.331713        1477.68
16      100     138.094 188.743 0.65416         995.815
17      100     178.589 221.764 1.43332         1162.86
18      100     190.742 350.895 0.12314         2590.91
19      100     187.901 295.969 1.24931         1877.49
20      100     169.356 256.031 0.802431        1605.6
21      100     204.002 256.001 1.06013         1542.88
22      100     140.865 242.039 0.359996        1518.22
23      100     181.301 318.78  2.58391         2424.68
24      100     172.923 284.863 1.64867         1645.49
25      100     235.942 349.376 2.03303         1867.41
26      100     140.946 178.729 0.113659        885.405
27      100     175.488 241.043 2.30094         1309.11
28      100     160.52  261.292 0.759048        1781.37
29      100     250.082 452.672 1.6124          2847.8
30      100     144.46  166.938 0.288755        793.123
31      100     161.516 227.12  1.14722         1212.5
32      100     201.765 299.466 0.184742        2299.27
33      100     198.52  354.615 0.378559        2555.35
34      100     213.18  333.602 0.340119        1929.81
35      100     145.566 245.421 3.07432         1638.17
36      100     204.124 268.036 1.16989         1235.29
37      100     186.907 338.654 0.729171        1951.09
38      100     163.911 225.1   1.76316         1347.63
39      100     144.926 195.454 1.1748          864.487
40      100     220.008 412.648 0.156744        3435.67
41      100     199.047 293.792 0.237397        1418.05
42      100     167.405 349.672 1.8682          3207.77
43      100     172.532 247.392 0.149577        1137.32
44      100     150.746 225.731 1.33345         1613.83
45      100     214.564 298.889 2.82739         1735.32
46      100     201.385 315.195 0.925047        1874.5
47      100     174.342 265.759 1.50987         1600.58
48      100     162.501 234.035 0.250941        1462.07
49      100     237.547 408.212 0.109626        2599.48
50      100     176.729 239.149 0.294143        1124.61
51      100     206.552 319.797 0.516786        1907.74
52      100     170.441 235.575 0.507745        1198.99
53      100     196.408 378.167 0.804875        2865.17
54      100     233.04  443.894 0.666743        3936.75
55      100     196.568 318.835 0.273587        1798.72
56      100     186.25  330.674 1.10495         2379.27
57      100     162.715 268.559 0.490278        1917.74
58      100     176.907 202.106 0.460119        857.866
59      100     199.414 291.45  7.76274         1765.8
60      100     174.626 265.766 1.20472         1368.06
61      100     152.284 184.578 0.816291        930.812
62      100     199.021 251.696 1.98655         1223.91
63      100     200.188 298.897 0.104671        1992.02
64      100     165.157 243.549 5.74397         1822.08
65      100     170.031 219.416 0.699858        967.658
66      100     193.294 291.464 0.906403        1833.23
67      100     224.426 470.085 0.435998        3749.41
68      100     181.143 264.06  2.87098         1627.06
69      100     218.244 329.188 0.809391        1950.6
70      100     167.807 291.754 1.77498         2358.24
71      100     203.24  264.2   1.71181         1254.4
72      100     192.522 279.274 0.784083        1275.52
73      100     199.988 276.204 1.38586         2018.33
74      100     164.355 206.532 1.98748         1024.84
75      100     141.328 221.893 0.159428        1299.15
76      100     187.171 304.55  0.419191        2206.61
77      100     236.185 305.973 0.383859        1386.63
78      100     177.235 265.484 1.00303         1332.34
79      100     163.223 277.881 0.151669        2095.16
80      100     154.797 211.777 1.97566         1333.6
81      100     216.873 334.32  0.833326        1823.46
82      100     227.992 334.78  1.51969         1902.34
83      100     125.043 167.605 0.023797        1036.46
84      100     165.496 219.811 1.59097         1179.89
85      100     132.042 253.518 0.100372        1440.12
86      100     218.964 329.456 3.08183         2663.81
87      100     196.671 315.4   1.02842         2080.16
88      100     178.277 204.001 0.619776        1254.49
89      100     135.838 202.586 2.93795         949.907
90      100     168.148 232.946 2.38108         1405.97
91      100     189.175 263.479 0.470495        1666.38
92      100     191.37  318.936 0.51743         2342.82
93      100     205.068 336.895 0.811245        2396.24
94      100     156.604 228.162 0.570532        1184.09
95      100     195.133 310.057 3.84578         1971.87
96      100     185.451 258.802 0.273052        1657.04
97      100     172.867 250.03  0.79491         1345.88
98      100     179.979 268.615 0.737273        1680.93
99      100     180.712 289.489 1.6651          1386.36
100     100     204.718 308.558 0.216455        1707.79
101     100     171.145 314.824 0.414372        2272.8
102     100     180.751 239.498 0.0128631       1240.37
103     100     178.126 320.855 0.121879        2544.27
104     100     197.553 294.56  0.0128631       1698.44
105     100     190.156 294.437 0.363793        1459.52
106     100     163.597 232.99  0.0128631       927.565
107     100     159.059 215.484 2.13973         1088.99
108     100     229.357 416.678 0.739422        3449.89
109     100     224.385 320.857 0.164042        1875.1
110     100     185.724 274.19  0.164813        1595.91
111     100     175.071 396.747 1.48165         2483.68
112     100     171.478 249.275 0.950025        1336.66
113     100     266.303 394.154 2.21912         2002.45
114     100     279.098 440.895 0.514899        2354.95
115     100     152.781 215.956 0.101874        1043.32
116     100     149.47  284.293 0.138304        2156.27
117     100     231.716 288.753 0.207116        1361.07
118     100     168.162 251.926 0.91589         1907.26
119     100     200.791 349.73  0.528213        2835.43
120     100     234.207 353.967 3.49297         1702.64
121     100     158.793 191.991 0.219538        978.524
122     100     194.18  392.775 2.96123         3432.14
123     100     249.347 520.987 3.66334         3486.09
124     100     185.213 381.388 0.204508        3281.8
125     100     197.914 239.244 0.541101        1097.14
126     100     160.18  239.528 0.278855        1213.38
127     100     174.626 283.259 0.0712246       2321.9
128     100     147.465 182.48  0.202553        901.003
129     100     160.576 232.081 1.39518         1495.72
130     100     189.029 286.426 0.638741        1798.59
131     100     165.843 237.14  2.81123         1386.35
132     100     165.607 193.168 0.3562          934.614
133     100     157.026 324.992 0.0583916       2180.13
134     100     201.055 252.391 0.363347        1165.61
135     100     191.455 279.135 0.298419        1623.49
136     100     190.048 229.519 0.413613        1251.6
137     100     149.358 229.234 1.65108         1482.22
138     100     152.432 287.094 3.60066         2255.97
139     100     219.534 285.084 2.04006         1867.78
140     100     327.442 490.332 0.173127        3052.59
141     100     212.45  302.597 1.35093         1540.83
142     100     167.147 241.501 0.065922        1793.23
143     100     199.959 527.73  2.93428         5086.1
144     100     186.826 241.237 1.37183         1349.37
145     100     201.797 275.834 4.79055         1223.52
146     100     170.944 235.773 1.00683         1573.11
147     100     177.744 307.569 0.350236        2274.01
148     100     188.631 253.523 0.351289        1360.98
149     100     218.999 466.789 0.561193        2877.67
150     100     149.686 188.165 2.82761         829.43
151     100     120.023 186.511 0.483942        1474.84
152     100     178.63  289.212 1.9339          1957.83
153     100     251.314 449.308 1.36046         3037.87
154     100     177.095 283.979 0.0569922       2214.27
155     100     117.923 150.156 0.608793        719.644
156     100     164.259 219.955 1.09157         1039.77
157     100     208.389 292.885 1.59057         1918.86
158     100     185.926 238.909 0.354887        1215.66
159     100     115.772 163.111 0.57508         951.157
160     100     192.862 353.143 0.0608405       3001.53
161     100     203.939 314.762 0.0309515       1916.41
162     100     212.094 271.912 0.723564        1177.44
163     100     159.737 267.525 0.817969        2003.44
164     100     164.812 236.976 0.155459        1684.99
165     100     206.529 297.931 0.0358223       1745.84
166     100     273.481 402.797 0.830531        2748.74
167     100     164.058 227.976 0.0798364       1204.86
168     100     179.558 256.193 0.659841        1474.66
169     100     206.828 387.159 0.0496829       3204.39
170     100     215.322 308.947 0.893978        1692.22
171     100     164.927 226.853 0.442019        1171.51
172     100     183.26  242.302 0.898273        1209.84
173     100     215.744 311.723 0.157911        1769.67
174     100     214.588 291.767 0.213738        1383.8
175     100     162.834 205.17  0.522477        1223.24
176     100     168.436 271.054 0.187538        1870.36
177     100     161.765 201.164 0.220359        913.285
178     100     242.155 343.034 0.162978        1561.57
179     100     185.22  252.048 0.00290949      1783.44
180     100     155.598 186.896 0.916128        885.427
181     100     148.238 212.34  0.0126723       1516.8
182     100     156.295 182.358 0.0556589       799.385
183     100     220.21  328.293 0.848677        1369.19
184     100     174.567 290.227 3.71512         2032.72
185     100     156.093 216.229 0.00591467      1117.16
186     100     192.63  274.433 1.04027         1537.89
187     100     242.45  355.121 0.870505        1768.44
188     100     227.049 407.079 0.150761        3426.87
189     100     205.973 348.785 3.84129         2098.67
190     100     140.318 244.252 0.05084         1376.25
191     100     182.667 362.982 0.221067        2996.92
192     100     236.328 368.403 1.1194          2379.81
193     100     175.126 252.803 1.44737         1697.79
194     100     152.803 313.526 0.474042        2512
195     100     111.308 137.303 1.05037         674.563
196     100     197.697 311.294 0.679804        1823.59
197     100     222.033 343.067 3.96395         2162.41
198     100     146.529 168.518 0.150571        707.126
199     100     147.243 237.378 1.42665         1585.42
"""
